name: Check Issue Assignee CLA
on:
  push:
    branches:
      - issue#21643-cla
  issues:
    types:
      - assigned
  
permissions: read-all
jobs:
  check-cla:
    runs-on: ubuntu-24.04
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
      
      - name: Install Dependencies
        run: npm install googleapis google-auth-library

      - name: Check CLA signature
        id: check-cla
        uses: actions/github-script@v6
        env:
          SHEETS_CRED: '${{ secrets.SHEETS_CRED }}'
          SPREADSHEET_ID: '${{ secrets.SPREADSHEET_ID }}'
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          USERNAME: '${{ github.event.assignee.login }}'
          CREDENTIALS: '${{ secrets.CREDENTIALS }}'
        with:
          script: |
            console.log('Checking CLA signature...');
            const { google } = require('googleapis');
            const { OAuth2Client } = require('google-auth-library');
            console.log('Libraries installed successfully');
            const authorize = (credentials) => {
              const clientSecret = credentials.installed.client_secret;
              const clientId = credentials.installed.client_id;
              const redirectUrl = credentials.installed.redirect_uris[0];
              const oauth2Client = new OAuth2Client(clientId, clientSecret, redirectUrl);
              oauth2Client.credentials = JSON.parse(process.env.CREDENTIALS);
              return oauth2Client;
            };

            const clientSecret = process.env.SHEETS_CRED;
            const oauthClient = authorize(JSON.parse(clientSecret));
            const sheets = google.sheets('v4');

            const rows = await sheets.spreadsheets.values.get({
              auth: oauthClient,
              spreadsheetId: process.env.SPREADSHEET_ID,
              range: 'Usernames!A:A',
            });
            const username = process.env.USERNAME.toLowerCase();
            const hasSignedCla = rows.data.values.some(row => 
              row[0].toLowerCase() === username
            );
            
            core.setOutput('has-signed-cla', hasSignedCla ? 'true' : 'false');
            console.log(`User ${username} has ${hasSignedCla ? '' : 'not '}signed the CLA`);

      - name: Remove assignee and notify if CLA not signed
        if: steps.check-cla.outputs.has-signed-cla == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const assignee = context.payload.assignee;
            if (!issue || !assignee) {
              core.setFailed('Invalid event payload');
              return;
            }
            const linkToCla = '[here](https://github.com/oppia/oppia/wiki/Contributing-code-to-Oppia#setting-things-up)';

            const commentBody = `Hi @${assignee.login}, you need to sign the CLA before you can get assigned to issues. Follow the instructions ${linkToCla} to get started. I am unassigning you for now, feel free to assign yourself once you have signed the CLA. Thanks!`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: commentBody
            });
            await github.rest.issues.removeAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              assignees: [assignee.login]
            });
            console.log(`Removed assignee ${assignee.login} from issue #${issue.number} due to unsigned CLA`);
            
      - name: Report failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const message = "Failed to check CLA for issue assignee";
            const webhookUrl = process.env.WEBHOOK_URL;
            
            if (webhookUrl) {
              const https = require('https');
              const url = new URL(webhookUrl);
              
              const data = JSON.stringify({
                text: message
              });
              
              const options = {
                hostname: url.hostname,
                path: url.pathname,
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': data.length
                }
              };
              
              const req = https.request(options, (res) => {
                console.log(`Webhook notification sent with status code: ${res.statusCode}`);
              });
              
              req.on('error', (error) => {
                console.error('Error sending webhook notification:', error);
              });
              
              req.write(data);
              req.end();
            } else {
              console.log('No webhook URL provided, skipping notification');
            }
        env:
          WEBHOOK_URL: ${{ secrets.BUILD_FAILURE_ROOM_WEBHOOK_URL }}